

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7. 地址映射与共享 &mdash; Guojunos 1.0.0 文档</title>
  

  
  
    <link rel="shortcut icon" href="../_static/gj.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/guojun.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="8. 打印进程地址转换过程" href="lab06.html" />
    <link rel="prev" title="6. 信号量的实现和应用" href="lab04.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Guojunos
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">课程信息</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../course/slides.html">1. 课件资料</a></li>
<li class="toctree-l1"><a class="reference internal" href="../course/book.html">2. 使用教材</a></li>
<li class="toctree-l1"><a class="reference internal" href="../course/software.html">3. 所需软件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../course/schedule.html">4. 上课时间</a></li>
<li class="toctree-l1"><a class="reference internal" href="../course/report.html">5. 实验报告</a></li>
</ul>
<p class="caption"><span class="caption-text">课程实验</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../experiments/introduction.html">1. 实验环境</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experiments/VMware.html">2. 虚拟机环境安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experiments/BochsInstall.html">3. Bochs 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experiments/Linux000setup.html">4. Linux 0.00</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experiments/Linux011setup.html">5. Linux 0.11 on Ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experiments/Linux011Use.html">6. Linux 0.11 的使用方法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experiments/Linux011Flow.html">7. Linux 0.11 的工作模式</a></li>
</ul>
<p class="caption"><span class="caption-text">Intel手册读书笔记</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Intelx86/chap02.html">1. x86系统架构概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intelx86/chap03.html">2. 保护模式内存管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intelx86/chap04.html">3. 中断和异常处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intelx86/chap05.html">4. 任务管理</a></li>
</ul>
<p class="caption"><span class="caption-text">Linux 实验</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux000/lab01.html">1. 调试分析 Linux 0.00 引导程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux000/lab02.html">2. 调试分析 Linux 0.00 多任务切换</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab01.html">3. 操作系统的引导</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab02.html">4. 系统调用</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab03.html">5. 进程运行轨迹的跟踪与统计</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab04.html">6. 信号量的实现和应用</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">7. 地址映射与共享</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">7.1. 实验目的</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">7.2. 实验内容</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">7.2.1. 跟踪地址翻译过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">7.2.2. 基于共享内存的生产者—消费者程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">7.2.3. 共享内存的实现</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shmget">7.2.4. <code class="docutils literal notranslate"><span class="pre">shmget()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#shmat">7.2.5. <code class="docutils literal notranslate"><span class="pre">shmat()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">7.3. 实验报告</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">7.3.1. 评分标准</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id9">7.4. 实验提示</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">7.4.1. 准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">7.4.2. 暂停</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">7.4.3. 段表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">7.4.4. 段描述符</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">7.4.5. 段基址和线性地址</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">7.4.6. 页表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">7.4.7. 物理地址</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linux">7.4.8. Linux 中的共享内存</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linux-0-11">7.4.9. 在 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 中实现共享内存</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">7.4.9.1. 获得空闲物理页面</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">7.4.9.2. 地址映射</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">7.4.9.3. 寻找空闲的虚拟地址空间</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id20">7.5. 可能遇到的问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#trying-to-free-free-page">7.5.1. trying to free free page</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab06.html">8. 打印进程地址转换过程</a></li>
</ul>
<p class="caption"><span class="caption-text">附录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/BIOS.html">1. 中断向量表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/Bochs.html">2. Bochs 手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/FAQ.html">3. FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Guojunos</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>7. 地址映射与共享</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>7. 地址映射与共享<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>7.1. 实验目的<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>深入理解操作系统的段、页式内存管理，深入理解段表、页表、逻辑地址、线性地址、物理地址等概念；</p></li>
<li><p>实践段、页式内存管理的地址映射过程；</p></li>
<li><p>编程实现段、页式内存管理上的内存共享，从而深入理解操作系统的内存管理。</p></li>
</ul>
</div>
<div class="section" id="id3">
<h2>7.2. 实验内容<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>本次实验的基本内容是：</p>
<ul class="simple">
<li><p>用 <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 调试工具跟踪 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 的地址翻译（地址映射）过程，了解 <code class="docutils literal notranslate"><span class="pre">IA-32</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 的内存管理机制；</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">Ubuntu</span></code> 上编写多进程的生产者-消费者程序，用共享内存做缓冲区；</p></li>
<li><p>在信号量实验的基础上，为 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 增加共享内存功能，并将生产者-消费者程序移植到 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 。</p></li>
</ul>
<div class="section" id="id4">
<h3>7.2.1. 跟踪地址翻译过程<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>首先以汇编级调试的方式启动 <code class="docutils literal notranslate"><span class="pre">bochs</span></code> ，引导 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> ，并在其下编译和运行 <code class="docutils literal notranslate"><span class="pre">test.c</span></code> 。
它是一个无限循环的程序，永远不会主动退出。
然后在调试器中通过查看各项系统参数，从逻辑地址、 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 表、 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> 表、线性地址到页表，计算出变量 <code class="docutils literal notranslate"><span class="pre">i</span></code> 的物理地址。
最后通过直接修改物理内存的方式让 <code class="docutils literal notranslate"><span class="pre">test.c</span></code> 退出运行。 <code class="docutils literal notranslate"><span class="pre">test.c</span></code> 的代码如下：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The logical/virtual address of i is 0x%08x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>7.2.2. 基于共享内存的生产者—消费者程序<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>本项实验在 <code class="docutils literal notranslate"><span class="pre">Ubuntu</span></code> 下完成，与信号量实验中的 <code class="docutils literal notranslate"><span class="pre">pc.c</span></code> 的功能要求基本一致，仅有两点不同：</p>
<ul class="simple">
<li><p>不用文件做缓冲区，而是使用共享内存；</p></li>
<li><p>生产者和消费者分别是不同的程序。生产者是 <code class="docutils literal notranslate"><span class="pre">producer.c</span></code> ，消费者是 <code class="docutils literal notranslate"><span class="pre">consumer.c</span></code> 。两个程序都是单进程的，通过信号量和缓冲区进行通信。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> 下，可以通过 <code class="docutils literal notranslate"><span class="pre">shmget()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shmat()</span></code> 两个系统调用使用共享内存。</p>
</div>
<div class="section" id="id6">
<h3>7.2.3. 共享内存的实现<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>进程之间可以通过页共享进行通信，被共享的页叫做共享内存，结构如下图所示：</p>
<p><img alt="共享内存" src="../_images/lab05_ShareMemory.svg" /></p>
<p>图1. 共享内存</p>
<p><img alt="段页式" src="../_images/lab05_SegmentationPaging.png" /></p>
<p>图2. 段页式</p>
<p>本部分实验内容是在 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 上实现上述页面共享，并将上一部分实现的 <code class="docutils literal notranslate"><span class="pre">producer.c</span></code> 和 <code class="docutils literal notranslate"><span class="pre">consumer.c</span></code> 移植过来，验证页面共享的有效性。</p>
<p>具体要求在 <code class="docutils literal notranslate"><span class="pre">mm/shm.c</span></code> 中实现 <code class="docutils literal notranslate"><span class="pre">shmget()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shmat()</span></code> 两个系统调用。它们能支持 <code class="docutils literal notranslate"><span class="pre">producer.c</span></code> 和 <code class="docutils literal notranslate"><span class="pre">consumer.c</span></code> 的运行即可，不需要完整地实现 <code class="docutils literal notranslate"><span class="pre">POSIX</span></code> 所规定的功能。</p>
</div>
<div class="section" id="shmget">
<h3>7.2.4. <code class="docutils literal notranslate"><span class="pre">shmget()</span></code><a class="headerlink" href="#shmget" title="永久链接至标题">¶</a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">shmget</span><span class="p">(</span><span class="kt">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">shmget()</span></code> 会新建/打开一页内存，并返回该页共享内存的 <code class="docutils literal notranslate"><span class="pre">shmid</span></code> （该块共享内存在操作系统内部的 <code class="docutils literal notranslate"><span class="pre">id</span></code> ）。
所有使用同一块共享内存的进程都要使用相同的 <code class="docutils literal notranslate"><span class="pre">key</span></code> 参数。
如果 <code class="docutils literal notranslate"><span class="pre">key</span></code> 所对应的共享内存已经建立，则直接返回 <code class="docutils literal notranslate"><span class="pre">shmid</span></code> 。
如果 <code class="docutils literal notranslate"><span class="pre">size</span></code> 超过一页内存的大小，返回 <code class="docutils literal notranslate"><span class="pre">-1</span></code> ，并置 <code class="docutils literal notranslate"><span class="pre">errno</span></code> 为 <code class="docutils literal notranslate"><span class="pre">EINVAL</span></code> 。
如果系统无空闲内存，返回 <code class="docutils literal notranslate"><span class="pre">-1</span></code> ，并置 <code class="docutils literal notranslate"><span class="pre">errno</span></code> 为 <code class="docutils literal notranslate"><span class="pre">ENOMEM</span></code> 。 <code class="docutils literal notranslate"><span class="pre">shmflg</span></code> 参数可忽略。</p>
</div>
<div class="section" id="shmat">
<h3>7.2.5. <code class="docutils literal notranslate"><span class="pre">shmat()</span></code><a class="headerlink" href="#shmat" title="永久链接至标题">¶</a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">shmat</span><span class="p">(</span><span class="kt">int</span> <span class="n">shmid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">shmaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">shmat()</span></code> 会将 <code class="docutils literal notranslate"><span class="pre">shmid</span></code> 指定的共享页面映射到当前进程的虚拟地址空间中，并将其首地址返回。
如果 <code class="docutils literal notranslate"><span class="pre">shmid</span></code> 非法，返回 <code class="docutils literal notranslate"><span class="pre">-1</span></code> ，并置 <code class="docutils literal notranslate"><span class="pre">errno</span></code> 为 <code class="docutils literal notranslate"><span class="pre">EINVAL</span></code> 。 <code class="docutils literal notranslate"><span class="pre">shmaddr</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shmflg</span></code> 参数可忽略。</p>
</div>
</div>
<div class="section" id="id7">
<h2>7.3. 实验报告<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>完成实验后，在实验报告中回答如下问题：</p>
<ul class="simple">
<li><p>对于地址映射实验部分，列出你认为最重要的那几步（不超过 <code class="docutils literal notranslate"><span class="pre">4</span></code> 步），并给出你获得的实验数据。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test.c</span></code> 退出后，如果马上再运行一次，并再进行地址跟踪，你发现有哪些异同？为什么？</p></li>
</ul>
<div class="section" id="id8">
<h3>7.3.1. 评分标准<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>跟踪地址映射的过程，20%</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shmget()</span></code> ，10%</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shmat()</span></code> ，10%</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">producer.c</span></code> ，15%</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">consumer.c</span></code> ，15%</p></li>
<li><p>实验报告，30%</p></li>
</ul>
</div>
</div>
<div class="section" id="id9">
<h2>7.4. 实验提示<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<p>《注释》中的 <code class="docutils literal notranslate"><span class="pre">5.3</span></code> 节和第 <code class="docutils literal notranslate"><span class="pre">13</span></code> 章对 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 的内存管理有详细分析、讲解，很值得一看。</p>
<p><code class="docutils literal notranslate"><span class="pre">IA-32</span></code> 的地址翻译过程</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 完全遵循IA-32（Intel Architecture 32-bit）架构进行地址翻译，<code class="docutils literal notranslate"><span class="pre">Windows</span></code> 、后续版本的 <code class="docutils literal notranslate"><span class="pre">Linux</span></code> 以及一切在 <code class="docutils literal notranslate"><span class="pre">IA-32</span></code> 保护模式下运行的操作系统都遵循此架构。</p>
</div></blockquote>
<p>因为只有这样才能充分发挥 <code class="docutils literal notranslate"><span class="pre">CPU</span></code> 的 <code class="docutils literal notranslate"><span class="pre">MMU</span></code> 的功能。
关于此地址翻译过程的细节，请参考《注释》一书中的 <code class="docutils literal notranslate"><span class="pre">5.3.1-5.3.4</span></code> 节。</p>
<p>用 <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 汇编级调试功能进行人工地址翻译</p>
<p>此过程比较机械，基本不消耗脑细胞，做一下有很多好处。</p>
<div class="section" id="id10">
<h3>7.4.1. 准备<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>编译好 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 后，首先通过运行 <code class="docutils literal notranslate"><span class="pre">./run</span></code> 启动调试器，此时 <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 的窗口处于黑屏状态，而命令行窗口显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">========================================================================</span>
                        <span class="n">Bochs</span> <span class="n">x86</span> <span class="n">Emulator</span> <span class="mf">2.6</span>
            <span class="n">Built</span> <span class="kn">from</span> <span class="nn">SVN</span> <span class="n">snapshot</span> <span class="n">on</span> <span class="n">September</span> <span class="mi">2</span><span class="n">nd</span><span class="p">,</span> <span class="mi">2012</span>
<span class="o">========================================================================</span>
<span class="n">Next</span> <span class="n">at</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
<span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">[</span><span class="mh">0x00000000fffffff0</span><span class="p">]</span> <span class="n">f000</span><span class="p">:</span><span class="n">fff0</span> <span class="p">(</span><span class="n">unk</span><span class="o">.</span> <span class="n">ctxt</span><span class="p">):</span> <span class="n">jmp</span> <span class="n">far</span> <span class="n">f000</span><span class="p">:</span><span class="n">e05b</span>         <span class="p">;</span> <span class="n">ea5be000f0</span>
<span class="o">&lt;</span><span class="n">bochs</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span><span class="n">_</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Next</span> <span class="pre">at</span> <span class="pre">t=0</span></code> 表示下面的指令是 <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 启动后要执行的第一条软件指令。单步跟踪进去就能看到 <code class="docutils literal notranslate"><span class="pre">BIOS</span></code> 的代码。不过这不是本实验需要的。直接输入命令 <code class="docutils literal notranslate"><span class="pre">c</span></code> ， <code class="docutils literal notranslate"><span class="pre">continue</span></code> 程序的运行， <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 一如既往地启动了 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 下输入（或拷入） <code class="docutils literal notranslate"><span class="pre">test.c</span></code> ，编译为 <code class="docutils literal notranslate"><span class="pre">test</span></code> ，运行之，打印如下信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">logical</span><span class="o">/</span><span class="n">virtual</span> <span class="n">address</span> <span class="n">of</span> <span class="n">i</span> <span class="ow">is</span> <span class="mh">0x00003004</span>
</pre></div>
</div>
<p>只要 <code class="docutils literal notranslate"><span class="pre">test</span></code> 不变， <code class="docutils literal notranslate"><span class="pre">0x00003004</span></code> 这个值在任何人的机器上都是一样的。即使在同一个机器上多次运行 <code class="docutils literal notranslate"><span class="pre">test</span></code> ，也是一样的。</p>
<p><code class="docutils literal notranslate"><span class="pre">test</span></code> 是一个死循环，只会不停占用 <code class="docutils literal notranslate"><span class="pre">CPU</span></code> ，不会退出。</p>
</div>
<div class="section" id="id11">
<h3>7.4.2. 暂停<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>当 <code class="docutils literal notranslate"><span class="pre">test</span></code> 运行的时候，在命令行窗口按 <code class="docutils literal notranslate"><span class="pre">Ctrl+c</span></code> ， <code class="docutils literal notranslate"><span class="pre">Bochs``会暂停运行，进入调试状态。绝大多数情况下都会停在</span> <span class="pre">``test</span></code> 内，显示类似如下信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">[</span><span class="mh">0x00fc8031</span><span class="p">]</span> <span class="mi">000</span><span class="n">f</span><span class="p">:</span><span class="mi">00000031</span> <span class="p">(</span><span class="n">unk</span><span class="o">.</span> <span class="n">ctxt</span><span class="p">):</span> <span class="nb">cmp</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="p">:</span><span class="mh">0x3004</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">;</span> <span class="mi">833</span><span class="n">d0430000000</span>
</pre></div>
</div>
<p>其中加粗的 <code class="docutils literal notranslate"><span class="pre">000f</span></code> 如果是 <code class="docutils literal notranslate"><span class="pre">0008</span></code> ，则说明中断在了内核里。那么就要 <code class="docutils literal notranslate"><span class="pre">c</span></code> ，然后再 <code class="docutils literal notranslate"><span class="pre">Ctrl+c</span></code> ，直到变为 <code class="docutils literal notranslate"><span class="pre">000f</span></code> 为止。如果显示的下一条指令不是 <code class="docutils literal notranslate"><span class="pre">cmp</span> <span class="pre">...</span></code> ，就用 <code class="docutils literal notranslate"><span class="pre">n</span></code> 命令单步运行几步，直到停在 <code class="docutils literal notranslate"><span class="pre">cmp</span> <span class="pre">...</span></code> 。</p>
<p>使用命令 <code class="docutils literal notranslate"><span class="pre">u</span> <span class="pre">/7</span></code> ，显示从当前位置开始 <code class="docutils literal notranslate"><span class="pre">7</span></code> 条指令的反汇编代码，如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">10000031</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="nb">cmp</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="p">:</span><span class="mh">0x3004</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">;</span> <span class="mi">833</span><span class="n">d0430000000</span>
<span class="mi">10000038</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="n">jz</span> <span class="o">.+</span><span class="mh">0x00000002</span>           <span class="p">;</span> <span class="mi">7402</span>
<span class="mi">1000003</span><span class="n">a</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="n">jmp</span> <span class="o">.+</span><span class="mh">0xfffffff5</span>          <span class="p">;</span> <span class="n">ebf5</span>
<span class="mi">1000003</span><span class="n">c</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>              <span class="p">;</span> <span class="mi">31</span><span class="n">c0</span>
<span class="mi">1000003</span><span class="n">e</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="n">jmp</span> <span class="o">.+</span><span class="mh">0x00000000</span>          <span class="p">;</span> <span class="n">eb00</span>
<span class="mi">10000040</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="n">leave</span>                     <span class="p">;</span> <span class="n">c9</span>
<span class="mi">10000041</span><span class="p">:</span> <span class="p">(</span>                    <span class="p">):</span> <span class="n">ret</span>                       <span class="p">;</span> <span class="n">c3</span>
</pre></div>
</div>
<p>这就是 <code class="docutils literal notranslate"><span class="pre">test.c</span></code> 中从 <code class="docutils literal notranslate"><span class="pre">while</span></code> 开始一直到 <code class="docutils literal notranslate"><span class="pre">return</span></code> 的汇编代码。变量 <code class="docutils literal notranslate"><span class="pre">i</span></code> 保存在 <code class="docutils literal notranslate"><span class="pre">ds:0x3004</span></code> 这个地址，并不停地和 <code class="docutils literal notranslate"><span class="pre">0</span></code> 进行比较，直到它为 <code class="docutils literal notranslate"><span class="pre">0</span></code> ，才会跳出循环。</p>
<p>现在，开始寻找 <code class="docutils literal notranslate"><span class="pre">ds:0x3004</span></code> 对应的物理地址。</p>
</div>
<div class="section" id="id12">
<h3>7.4.3. 段表<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ds:0x3004</span></code> 是虚拟地址， <code class="docutils literal notranslate"><span class="pre">ds</span></code> 表明这个地址属于 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 段。首先要找到段表，然后通过 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 的值在段表中找到 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 段的具体信息，才能继续进行地址翻译。每个在 <code class="docutils literal notranslate"><span class="pre">IA-32</span></code> 上运行的应用程序都有一个段表，叫 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> ，段的信息叫段描述符。</p>
<p><code class="docutils literal notranslate"><span class="pre">LDT</span></code> 在哪里呢？ <code class="docutils literal notranslate"><span class="pre">ldtr</span></code> 寄存器是线索的起点，通过它可以在 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> （全局描述符表）中找到 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 的物理地址。</p>
<p>用 <code class="docutils literal notranslate"><span class="pre">sreg</span></code> 命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x000f</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00000002</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0fa00</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">ds</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">3</span>
<span class="n">ss</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">es</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fs</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gs</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">ldtr</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0068</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0xc2d00068</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x000082f9</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">tr</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0060</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x52e80068</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x00008bfd</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gdtr</span><span class="p">:</span><span class="n">base</span><span class="o">=</span><span class="mh">0x00005cc8</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mh">0x7ff</span>
<span class="n">idtr</span><span class="p">:</span><span class="n">base</span><span class="o">=</span><span class="mh">0x000054c8</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mh">0x7ff</span>
</pre></div>
</div>
<p>可以看到 <code class="docutils literal notranslate"><span class="pre">ldtr</span></code> 的值是 <code class="docutils literal notranslate"><span class="pre">0x0068=0000000001101000</span></code> （二进制），表示 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 表存放在 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> 表的 <code class="docutils literal notranslate"><span class="pre">1101(二进制)=13（十进制）</span></code>  号位置（每位数据的意义参考后文叙述的段选择子）。而 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> 的位置已经由 <code class="docutils literal notranslate"><span class="pre">gdtr</span></code> 明确给出，在物理地址的 <code class="docutils literal notranslate"><span class="pre">0x00005cc8</span></code> 。
用 <code class="docutils literal notranslate"><span class="pre">xp</span> <span class="pre">/32w</span> <span class="pre">0x00005cc8</span></code> 查看从该地址开始， <code class="docutils literal notranslate"><span class="pre">32</span></code> 个字的内容，及 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> 表的前 <code class="docutils literal notranslate"><span class="pre">16</span></code> 项，如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00005cc8</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000fff</span>    <span class="mh">0x00c09a00</span>
<span class="mh">0x00005cd8</span> <span class="p">:</span>    <span class="mh">0x00000fff</span>    <span class="mh">0x00c09300</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00005ce8</span> <span class="p">:</span>    <span class="mh">0xa4280068</span>    <span class="mh">0x00008901</span>    <span class="mh">0xa4100068</span>    <span class="mh">0x00008201</span>
<span class="mh">0x00005cf8</span> <span class="p">:</span>    <span class="mh">0xf2e80068</span>    <span class="mh">0x000089ff</span>    <span class="mh">0xf2d00068</span>    <span class="mh">0x000082ff</span>
<span class="mh">0x00005d08</span> <span class="p">:</span>    <span class="mh">0xd2e80068</span>    <span class="mh">0x000089ff</span>    <span class="mh">0xd2d00068</span>    <span class="mh">0x000082ff</span>
<span class="mh">0x00005d18</span> <span class="p">:</span>    <span class="mh">0x12e80068</span>    <span class="mh">0x000089fc</span>    <span class="mh">0x12d00068</span>    <span class="mh">0x000082fc</span>
<span class="mh">0x00005d28</span> <span class="p">:</span>    <span class="mh">0xc2e80068</span>    <span class="mh">0x00008bf9</span>    <span class="mh">0xc2d00068</span>    <span class="mh">0x000082f9</span>
<span class="mh">0x00005d38</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GDT</span></code> 表中的每一项占 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位（ <code class="docutils literal notranslate"><span class="pre">8</span></code> 个字节），所以我们要查找的项的地址是
<code class="docutils literal notranslate"><span class="pre">0x00005cc8</span> <span class="pre">+</span> <span class="pre">13</span> <span class="pre">*8</span></code> 。
<code class="docutils literal notranslate"><span class="pre">xp</span> <span class="pre">/2w</span> <span class="pre">0x00005cc8</span> <span class="pre">+</span> <span class="pre">13*</span> <span class="pre">8</span></code> ，得到：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00005d30</span> <span class="p">:</span>    <span class="mh">0xc2d00068</span>    <span class="mh">0x000082f9</span>
</pre></div>
</div>
<p>上两步看到的数值可能和这里给出的示例不一致，这是很正常的。如果想确认是否准确，就看 <code class="docutils literal notranslate"><span class="pre">sreg</span></code> 输出中， <code class="docutils literal notranslate"><span class="pre">ldtr</span></code> 所在行里， <code class="docutils literal notranslate"><span class="pre">dl</span></code> 和 <code class="docutils literal notranslate"><span class="pre">dh</span></code> 的值，它们是 <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 的调试器自动计算出的，你寻找到的必须和它们一致。</p>
<p><code class="docutils literal notranslate"><span class="pre">0xc2d00068</span> <span class="pre">0x000082f9</span></code> 将其中的加粗数字组合为 <code class="docutils literal notranslate"><span class="pre">0x00f9c2d0</span></code>，这就是 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 表的物理地址（为什么这么组合，参考后文介绍的段描述符）。
<code class="docutils literal notranslate"><span class="pre">xp</span> <span class="pre">/8w</span> <span class="pre">0x00f9c2d0</span></code> ，得到：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00f9c2d0</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000002</span>    <span class="mh">0x10c0fa00</span>
<span class="mh">0x00f9c2e0</span> <span class="p">:</span>    <span class="mh">0x00003fff</span>    <span class="mh">0x10c0f300</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00f9d000</span>
</pre></div>
</div>
<p>这就是 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 表的前 <code class="docutils literal notranslate"><span class="pre">4</span></code> 项内容了。</p>
</div>
<div class="section" id="id13">
<h3>7.4.4. 段描述符<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>在保护模式下，段寄存器有另一个名字，叫段选择子，因为它保存的信息主要是该段在段表里索引值，用这个索引值可以从段表中“选择”出相应的段描述符。</p>
<p>先看看 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 选择子的内容，还是用 <code class="docutils literal notranslate"><span class="pre">sreg</span></code> 命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x000f</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00000002</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0fa00</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">ds</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">3</span>
<span class="n">ss</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">es</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fs</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gs</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x00003fff</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x10c0f300</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">ldtr</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0068</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x52d00068</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x000082fd</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">tr</span><span class="p">:</span><span class="n">s</span><span class="o">=</span><span class="mh">0x0060</span><span class="p">,</span> <span class="n">dl</span><span class="o">=</span><span class="mh">0x52e80068</span><span class="p">,</span> <span class="n">dh</span><span class="o">=</span><span class="mh">0x00008bfd</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gdtr</span><span class="p">:</span><span class="n">base</span><span class="o">=</span><span class="mh">0x00005cc8</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mh">0x7ff</span>
<span class="n">idtr</span><span class="p">:</span><span class="n">base</span><span class="o">=</span><span class="mh">0x000054c8</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mh">0x7ff</span>
</pre></div>
</div>
<p>可以看到， <code class="docutils literal notranslate"><span class="pre">ds</span></code> 的值是 <code class="docutils literal notranslate"><span class="pre">0x0017</span></code> 。段选择子是一个 <code class="docutils literal notranslate"><span class="pre">16</span></code> 位寄存器，它各位的含义如下图：</p>
<p><img alt="段选择子" src="../_images/lab05_SegmentSelector.png" /></p>
<p>图3. 段选择子</p>
<p>其中 <code class="docutils literal notranslate"><span class="pre">RPL</span></code> 是请求特权级，当访问一个段时，处理器要检查 <code class="docutils literal notranslate"><span class="pre">RPL</span></code> 和 <code class="docutils literal notranslate"><span class="pre">CPL</span></code> （放在 <code class="docutils literal notranslate"><span class="pre">cs</span></code> 的位 <code class="docutils literal notranslate"><span class="pre">0</span></code> 和位 <code class="docutils literal notranslate"><span class="pre">1</span></code> 中，用来表示当前代码的特权级），即使程序有足够的特权级（ <code class="docutils literal notranslate"><span class="pre">CPL</span></code> ）来访问一个段，但如果 <code class="docutils literal notranslate"><span class="pre">RPL</span></code> （如放在 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 中，表示请求数据段）的特权级不足，则仍然不能访问，即如果 <code class="docutils literal notranslate"><span class="pre">RPL</span></code> 的数值大于 <code class="docutils literal notranslate"><span class="pre">CPL</span></code> （数值越大，权限越小），则用 <code class="docutils literal notranslate"><span class="pre">RPL</span></code> 的值覆盖 <code class="docutils literal notranslate"><span class="pre">CPL</span></code> 的值。而段选择子中的 <code class="docutils literal notranslate"><span class="pre">TI</span></code> 是表指示标记，如果 <code class="docutils literal notranslate"><span class="pre">TI=0</span></code> ，则表示段描述符（段的详细信息）在 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> （全局描述符表）中，即去 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> 中去查；而 <code class="docutils literal notranslate"><span class="pre">TI=1</span></code> ，则去 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> （局部描述符表）中去查。</p>
<p>看看上面的 <code class="docutils literal notranslate"><span class="pre">ds</span></code> ， <code class="docutils literal notranslate"><span class="pre">0x0017=0000000000010111</span></code> （二进制），所以 <code class="docutils literal notranslate"><span class="pre">RPL=11</span></code> ，可见是在最低的特权级（因为在应用程序中执行）， <code class="docutils literal notranslate"><span class="pre">TI=1</span></code> ，表示查找 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 表，索引值为 <code class="docutils literal notranslate"><span class="pre">10（二进制）=</span> <span class="pre">2（十进制）</span></code> ，表示找 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> 表中的第 <code class="docutils literal notranslate"><span class="pre">3</span></code> 个段描述符（从 <code class="docutils literal notranslate"><span class="pre">0</span></code> 开始编号）。</p>
<p><code class="docutils literal notranslate"><span class="pre">LDT</span></code> 和 <code class="docutils literal notranslate"><span class="pre">GDT</span></code> 的结构一样，每项占 <code class="docutils literal notranslate"><span class="pre">8</span></code> 个字节。所以第 <code class="docutils literal notranslate"><span class="pre">3</span></code> 项 <code class="docutils literal notranslate"><span class="pre">0x00003fff</span> <span class="pre">0x10c0f300</span></code> 就是搜寻好久的 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 的段描述符了。用 <code class="docutils literal notranslate"><span class="pre">sreg</span></code> 输出中 <code class="docutils literal notranslate"><span class="pre">ds</span></code> 所在行的 <code class="docutils literal notranslate"><span class="pre">dl</span></code> 和 <code class="docutils literal notranslate"><span class="pre">dh</span></code> 值可以验证找到的描述符是否正确。</p>
<p>接下来看看段描述符里面放置的是什么内容：</p>
<p><img alt="段描述符" src="../_images/lab05_SegmentDescriptor.png" /></p>
<p>图4. 段描述符</p>
<p>可以看到，段描述符是一个 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位二进制的数，存放了段基址和段限长等重要的数据。其中位 <code class="docutils literal notranslate"><span class="pre">P</span></code> （Present）是段是否存在的标记；位 <code class="docutils literal notranslate"><span class="pre">S</span></code> 用来表示是系统段描述符（ <code class="docutils literal notranslate"><span class="pre">S=0</span></code> ）还是代码或数据段描述符（ <code class="docutils literal notranslate"><span class="pre">S=1</span></code> ）；四位 <code class="docutils literal notranslate"><span class="pre">TYPE</span></code> 用来表示段的类型，如数据段、代码段、可读、可写等； <code class="docutils literal notranslate"><span class="pre">DPL</span></code> 是段的权限，和 <code class="docutils literal notranslate"><span class="pre">CPL</span></code> 、 <code class="docutils literal notranslate"><span class="pre">RPL</span></code> 对应使用；位 <code class="docutils literal notranslate"><span class="pre">G</span></code> 是粒度， <code class="docutils literal notranslate"><span class="pre">G=0</span></code> 表示段限长以位为单位， <code class="docutils literal notranslate"><span class="pre">G=1</span></code> 表示段限长以 <code class="docutils literal notranslate"><span class="pre">4KB</span></code> 为单位；其他内容就不详细解释了。</p>
</div>
<div class="section" id="id14">
<h3>7.4.5. 段基址和线性地址<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<p>费了很大的劲，实际上我们需要的只有段基址一项数据，即段描述符 <code class="docutils literal notranslate"><span class="pre">0x00003fff</span> <span class="pre">0x10c0f300</span></code> 中加粗部分组合成的 <code class="docutils literal notranslate"><span class="pre">0x10000000</span></code> 。这就是ds段在线性地址空间中的起始地址。用同样的方法也可以算算其它段的基址，都是这个数。</p>
<p><strong>段基址+段内偏移</strong> ，就是 <strong>线性地址</strong> 了。所以 <code class="docutils literal notranslate"><span class="pre">ds:0x3004</span></code> 的线性地址就是：
<code class="docutils literal notranslate"><span class="pre">0x10000000</span> <span class="pre">+</span> <span class="pre">0x3004</span> <span class="pre">=</span> <span class="pre">0x10003004</span></code>
用 <code class="docutils literal notranslate"><span class="pre">calc</span> <span class="pre">ds:0x3004</span></code> 命令可以验证这个结果。</p>
</div>
<div class="section" id="id15">
<h3>7.4.6. 页表<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<p>从线性地址计算物理地址，需要查找页表。线性地址变成物理地址的过程如下：</p>
<p><img alt="线性地址变成物理地址" src="../_images/lab05_pagingTranslation.png" /></p>
<p>图5. 线性地址变成物理地址</p>
<p>首先需要算出线性地址中的页目录号、页表号和页内偏移，它们分别对应了 <code class="docutils literal notranslate"><span class="pre">32</span></code> 位线性地址的 <code class="docutils literal notranslate"><span class="pre">10位+10位+12位</span></code> ，所以 <code class="docutils literal notranslate"><span class="pre">0x10003004</span></code> 的页目录号是 <code class="docutils literal notranslate"><span class="pre">64</span></code> ，页号 <code class="docutils literal notranslate"><span class="pre">3</span></code> ，页内偏移是 <code class="docutils literal notranslate"><span class="pre">4</span></code> 。</p>
<p><code class="docutils literal notranslate"><span class="pre">IA-32</span></code> 下，页目录表的位置由 <code class="docutils literal notranslate"><span class="pre">CR3</span></code> 寄存器指引。 <code class="docutils literal notranslate"><span class="pre">creg</span></code> 命令可以看到：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CR0</span><span class="o">=</span><span class="mh">0x8000001b</span><span class="p">:</span> <span class="n">PG</span> <span class="n">cd</span> <span class="n">nw</span> <span class="n">ac</span> <span class="n">wp</span> <span class="n">ne</span> <span class="n">ET</span> <span class="n">TS</span> <span class="n">em</span> <span class="n">MP</span> <span class="n">PE</span>
<span class="n">CR2</span><span class="o">=</span><span class="n">page</span> <span class="n">fault</span> <span class="n">laddr</span><span class="o">=</span><span class="mh">0x10002f68</span>
<span class="n">CR3</span><span class="o">=</span><span class="mh">0x00000000</span>
    <span class="n">PCD</span><span class="o">=</span><span class="n">page</span><span class="o">-</span><span class="n">level</span> <span class="n">cache</span> <span class="n">disable</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">PWT</span><span class="o">=</span><span class="n">page</span><span class="o">-</span><span class="n">level</span> <span class="n">writes</span> <span class="n">transparent</span><span class="o">=</span><span class="mi">0</span>
<span class="n">CR4</span><span class="o">=</span><span class="mh">0x00000000</span><span class="p">:</span> <span class="n">osxmmexcpt</span> <span class="n">osfxsr</span> <span class="n">pce</span> <span class="n">pge</span> <span class="n">mce</span> <span class="n">pae</span> <span class="n">pse</span> <span class="n">de</span> <span class="n">tsd</span> <span class="n">pvi</span> <span class="n">vme</span>
</pre></div>
</div>
<p>说明页目录表的基址为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 。看看其内容， <code class="docutils literal notranslate"><span class="pre">xp</span> <span class="pre">/68w</span> <span class="pre">0</span></code> ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00000000</span> <span class="p">:</span>    <span class="mh">0x00001027</span>    <span class="mh">0x00002007</span>    <span class="mh">0x00003007</span>    <span class="mh">0x00004027</span>
<span class="mh">0x00000010</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00024764</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000020</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000030</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000040</span> <span class="p">:</span>    <span class="mh">0x00ffe027</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000050</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000060</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000070</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000080</span> <span class="p">:</span>    <span class="mh">0x00ff3027</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x00000090</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x000000a0</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x000000b0</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00ffb027</span>
<span class="mh">0x000000c0</span> <span class="p">:</span>    <span class="mh">0x00ff6027</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x000000d0</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x000000e0</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
<span class="mh">0x000000f0</span> <span class="p">:</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00ffa027</span>
<span class="mh">0x00000100</span> <span class="p">:</span>    <span class="mh">0x00faa027</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>    <span class="mh">0x00000000</span>
</pre></div>
</div>
<p>页目录表和页表中的内容很简单，是 <code class="docutils literal notranslate"><span class="pre">1024</span></code> 个 <code class="docutils literal notranslate"><span class="pre">32</span></code> 位（正好是 <code class="docutils literal notranslate"><span class="pre">4K</span></code> ）数。这 <code class="docutils literal notranslate"><span class="pre">32</span></code> 位中前 <code class="docutils literal notranslate"><span class="pre">20</span></code> 位是物理页框号，后面是一些属性信息（其中最重要的是最后一位 <code class="docutils literal notranslate"><span class="pre">P</span></code> ）。其中第 <code class="docutils literal notranslate"><span class="pre">65</span></code> 个页目录项就是我们要找的内容，用 <code class="docutils literal notranslate"><span class="pre">xp</span>
<span class="pre">/w</span> <span class="pre">0+64*4</span></code> 查看：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00000100</span> <span class="p">:</span>    <span class="mh">0x00faa027</span>
</pre></div>
</div>
<p>其中的 <code class="docutils literal notranslate"><span class="pre">027</span></code> 是属性，显然 <code class="docutils literal notranslate"><span class="pre">P=1</span></code> ，其他属性实验者自己分析吧。页表所在物理页框号为 <code class="docutils literal notranslate"><span class="pre">0x00faa</span></code> ，即页表在物理内存的 <code class="docutils literal notranslate"><span class="pre">0x00faa000</span></code> 位置。从该位置开始查找 <code class="docutils literal notranslate"><span class="pre">3</span></code> 号页表项，得到（ <code class="docutils literal notranslate"><span class="pre">xp</span>
<span class="pre">/w</span> <span class="pre">0x00faa000+3*4</span></code> ）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00faa00c</span> <span class="p">:</span>    <span class="mh">0x00fa7067</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">067</span></code> 是属性，显然 <code class="docutils literal notranslate"><span class="pre">P=1</span></code> ，应该是这样。</p>
</div>
<div class="section" id="id16">
<h3>7.4.7. 物理地址<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h3>
<p>最终结果马上就要出现了！</p>
<p>线性地址 <code class="docutils literal notranslate"><span class="pre">0x10003004</span></code> 对应的物理页框号为 <code class="docutils literal notranslate"><span class="pre">0x00fa7</span></code> ，和页内偏移 <code class="docutils literal notranslate"><span class="pre">0x004</span></code> 接到一起，得到 <code class="docutils literal notranslate"><span class="pre">0x00fa7004</span></code> ，这就是变量 <code class="docutils literal notranslate"><span class="pre">i</span></code> 的物理地址。可以通过两种方法验证。</p>
<p>第一种方法是用命令 <code class="docutils literal notranslate"><span class="pre">page</span> <span class="pre">0x10003004</span></code> ，可以得到信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">linear</span> <span class="n">page</span> <span class="mh">0x10003000</span> <span class="n">maps</span> <span class="n">to</span> <span class="n">physical</span> <span class="n">page</span> <span class="mh">0x00fa7000</span>
</pre></div>
</div>
<p>第二种方法是用命令 <code class="docutils literal notranslate"><span class="pre">xp</span> <span class="pre">/w</span> <span class="pre">0x00fa7004</span></code> ，可以看到：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00fa7004</span> <span class="p">:</span>    <span class="mh">0x12345678</span>
</pre></div>
</div>
<p>这个数值确实是 <code class="docutils literal notranslate"><span class="pre">test.c</span></code> 中 <code class="docutils literal notranslate"><span class="pre">i</span></code> 的初值。</p>
<p>现在，通过直接修改内存来改变 <code class="docutils literal notranslate"><span class="pre">i</span></code> 的值为 <code class="docutils literal notranslate"><span class="pre">0</span></code> ，命令是： <code class="docutils literal notranslate"><span class="pre">setpmem</span> <span class="pre">0x00fa7004</span> <span class="pre">4</span> <span class="pre">0</span></code> ，表示从 <code class="docutils literal notranslate"><span class="pre">0x00fa7004</span></code> 地址开始的 <code class="docutils literal notranslate"><span class="pre">4</span></code> 个字节都设为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 。然后再用 <code class="docutils literal notranslate"><span class="pre">c</span></code> 命令继续 <code class="docutils literal notranslate"><span class="pre">Bochs</span></code> 的运行，可以看到 <code class="docutils literal notranslate"><span class="pre">test</span></code> 退出了，说明i的修改成功了，此项实验结束。</p>
</div>
<div class="section" id="linux">
<h3>7.4.8. Linux 中的共享内存<a class="headerlink" href="#linux" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> 支持两种方式的共享内存:</p>
<ul class="simple">
<li><p>一种方式是 <code class="docutils literal notranslate"><span class="pre">shm_open()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">mmap()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shm_unlink()</span></code> 的组合；</p></li>
<li><p>另一种方式是 <code class="docutils literal notranslate"><span class="pre">shmget()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">shmat()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shmdt()</span></code> 的组合。</p></li>
</ul>
<p>本实验建议使用后一种方式。</p>
<p>这些系统调用的详情，请查阅 <code class="docutils literal notranslate"><span class="pre">man</span></code> 及相关资料。</p>
<p>特别提醒：没有父子关系的进程之间进行共享内存， <code class="docutils literal notranslate"><span class="pre">shmget()</span></code> 的第一个参数 <code class="docutils literal notranslate"><span class="pre">key</span></code> 不要用 <code class="docutils literal notranslate"><span class="pre">IPC_PRIVATE</span></code> ，否则无法共享。用什么数字可视心情而定。</p>
</div>
<div class="section" id="linux-0-11">
<h3>7.4.9. 在 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 中实现共享内存<a class="headerlink" href="#linux-0-11" title="永久链接至标题">¶</a></h3>
<div class="section" id="id17">
<h4>7.4.9.1. 获得空闲物理页面<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h4>
<p>实验者需要考虑如何实现页面共享。首先看一下 <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 如何操作页面，如何管理进程地址空间。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">kernel/fork.c</span></code> 文件中有：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">copy_process</span><span class="p">(</span> <span class="cm">/* …*/</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_free_page</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
    <span class="c1">// ……</span>
<span class="p">}</span>
</pre></div>
</div>
<p>函数 <code class="docutils literal notranslate"><span class="pre">get_free_page()</span></code> 用来获得一个空闲物理页面，在 <code class="docutils literal notranslate"><span class="pre">mm/memory.c</span></code> 文件中：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_free_page</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__res</span> <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ax&quot;</span><span class="p">);</span>
     <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;std ; repne ; scasb</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;jne 1f</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;movb $1,1(%%edi)</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;sall $12,%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>  <span class="c1">//页面数*4KB=相对页面起始地址</span>
             <span class="s">&quot;addl %2,%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>  <span class="c1">//在加上低端的内存地址，得到的是物理起始地址</span>
             <span class="s">&quot;movl %%ecx,%%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;movl $1024,%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;leal 4092(%%edx),%%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;rep ; stosl</span><span class="se">\n\t</span><span class="s">&quot;</span>
             <span class="s">&quot;movl %%edx,%%eax</span><span class="se">\n</span><span class="s">&quot;</span>  <span class="c1">//edx赋给eax，eax返回了物理起始地址</span>
             <span class="s">&quot;1:&quot;</span> <span class="o">:</span><span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">__res</span><span class="p">)</span> <span class="o">:</span><span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">LOW_MEM</span><span class="p">),</span><span class="s">&quot;c&quot;</span> <span class="p">(</span><span class="n">PAGING_PAGES</span><span class="p">),</span>
             <span class="s">&quot;D&quot;</span> <span class="p">(</span><span class="n">mem_map</span><span class="o">+</span><span class="n">PAGING_PAGES</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="s">&quot;di&quot;</span><span class="p">,</span><span class="s">&quot;cx&quot;</span><span class="p">,</span><span class="s">&quot;dx&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="n">__res</span><span class="p">;</span>
 <span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mem_map</span> <span class="p">[</span> <span class="n">PAGING_PAGES</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
</pre></div>
</div>
<p>显然 <code class="docutils literal notranslate"><span class="pre">get_free_page</span></code> 函数就是在 <code class="docutils literal notranslate"><span class="pre">mem_map</span></code> 位图中寻找值为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的项（空闲页面），该函数返回的是该页面的起始物理地址。</p>
</div>
<div class="section" id="id18">
<h4>7.4.9.2. 地址映射<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h4>
<p>有了空闲的物理页面，接下来需要完成线性地址和物理页面的映射， <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">0.11</span></code> 中也有这样的代码，看看 <code class="docutils literal notranslate"><span class="pre">mm/memory.c</span></code> 中的
<code class="docutils literal notranslate"><span class="pre">do_no_page(unsigned</span> <span class="pre">long</span> <span class="pre">address)</span></code> ，
该函数用来处理线性地址 <code class="docutils literal notranslate"><span class="pre">address</span></code> 对应的物理页面无效的情况（即缺页中断）， <code class="docutils literal notranslate"><span class="pre">do_no_page</span></code> 函数中调用一个重要的函数 <code class="docutils literal notranslate"><span class="pre">get_empty_page(address)</span></code> ，其中有：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="o">=</span><span class="n">get_free_page</span><span class="p">();</span>
<span class="n">put_page</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span> <span class="c1">//建立线性地址和物理地址的映射</span>
</pre></div>
</div>
<p>显然这两条语句就用来获得空闲物理页面，然后填写线性地址 <code class="docutils literal notranslate"><span class="pre">address</span></code> 对应的页目录和页表。</p>
</div>
<div class="section" id="id19">
<h4>7.4.9.3. 寻找空闲的虚拟地址空间<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h4>
<p>有了空闲物理页面，也有了建立线性地址和物理页面的映射，但要完成本实验还需要能获得一段空闲的虚拟地址空间。要从数据段中划出一段空间，首先需要了解进程数据段空间的分布，而这个分布显然是由 <code class="docutils literal notranslate"><span class="pre">exec</span></code> 系统调用决定的，所以要详细看一看 <code class="docutils literal notranslate"><span class="pre">exec</span></code> 的核心代码， <code class="docutils literal notranslate"><span class="pre">do_execve</span></code> （在文件 <code class="docutils literal notranslate"><span class="pre">fs/exec.c</span></code> 中）。在函数 <code class="docutils literal notranslate"><span class="pre">do_execve()</span></code> 中，修改数据段（当然是修改 <code class="docutils literal notranslate"><span class="pre">LDT</span></code> ）的地方是 <code class="docutils literal notranslate"><span class="pre">change_ldt</span></code> ，函数 <code class="docutils literal notranslate"><span class="pre">change_ldt</span></code> 实现如下：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">change_ldt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">text_size</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*其中text_size是代码段长度，从可执行文件的头部取出，page为参数和环境页*/</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code_limit</span><span class="p">,</span><span class="n">data_limit</span><span class="p">,</span><span class="n">code_base</span><span class="p">,</span><span class="n">data_base</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">code_limit</span> <span class="o">=</span> <span class="n">text_size</span><span class="o">+</span><span class="n">PAGE_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">code_limit</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFF000</span><span class="p">;</span>
    <span class="c1">//code_limit为代码段限长=text_size对应的页数（向上取整）</span>
    <span class="n">data_limit</span> <span class="o">=</span> <span class="mh">0x4000000</span><span class="p">;</span> <span class="c1">//数据段限长64MB</span>
    <span class="n">code_base</span> <span class="o">=</span> <span class="n">get_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="n">data_base</span> <span class="o">=</span> <span class="n">code_base</span><span class="p">;</span>

    <span class="c1">//数据段基址=代码段基址</span>
    <span class="n">set_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">code_base</span><span class="p">);</span> <span class="n">set_limit</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">code_limit</span><span class="p">);</span>
    <span class="n">set_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">data_base</span><span class="p">);</span> <span class="n">set_limit</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">data_limit</span><span class="p">);</span>
    <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;pushl $0x17</span><span class="se">\n\t</span><span class="s">pop %%fs&quot;</span><span class="o">::</span> <span class="p">);</span>
    <span class="n">data_base</span> <span class="o">+=</span> <span class="n">data_limit</span><span class="p">;</span> <span class="c1">//从数据段的末尾开始</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">MAX_ARG_PAGES</span><span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//向前处理</span>
        <span class="n">data_base</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>  <span class="c1">//一次处理一页</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data_base</span><span class="p">);</span> <span class="c1">//建立线性地址到物理页的映射</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data_limit</span><span class="p">;</span>  <span class="c1">//返回段界限</span>
<span class="p">}</span>
</pre></div>
</div>
<p>仔细分析过函数 <code class="docutils literal notranslate"><span class="pre">change_ldt</span></code> ，想必实验者已经知道该如何从数据段中找到一页空闲的线性地址。《注释》中的图 <code class="docutils literal notranslate"><span class="pre">13-6</span></code> 也能给你很大帮助。</p>
<p><img alt="进程逻辑地址空间分布" src="../_images/lab05_Logicalspace.png" /></p>
<p>图6. 进程代码和数据在其逻辑地址空间中的分布</p>
<p>在同一终端中同时运行两个程序</p>
<p>Linux的 <code class="docutils literal notranslate"><span class="pre">shell</span></code> 有后台运行程序的功能。只要在命令的最后输入一个 <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> ，命令就会进入后台运行，前台马上回到提示符，进而能运行下一个命令，例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">./producer <span class="p">&amp;</span></span>
<span class="prompt1">./consumer</span>
</pre></div></div><p>当运行 <code class="docutils literal notranslate"><span class="pre">./consumer</span></code> 的时候， <code class="docutils literal notranslate"><span class="pre">producer</span></code> 正在后台运行。</p>
</div>
</div>
</div>
<div class="section" id="id20">
<h2>7.5. 可能遇到的问题<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h2>
<div class="section" id="trying-to-free-free-page">
<h3>7.5.1. trying to free free page<a class="headerlink" href="#trying-to-free-free-page" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">linux-0.11</span></code> 下添加系统调用实现共享内存并编写完程序后，运行过程中可能会发现消费者程序运行结束后终端打印了  <code class="docutils literal notranslate"><span class="pre">trying</span> <span class="pre">to</span> <span class="pre">free</span> <span class="pre">free</span> <span class="pre">page</span></code> 并死机，
通过简单的调试可以发现这是程序调用 <code class="docutils literal notranslate"><span class="pre">memory.c</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">free_page()</span></code> 函数导致的，<code class="docutils literal notranslate"><span class="pre">panic</span></code> 会打印传入的参数字符串并死循环。</p>
<p>查看 <code class="docutils literal notranslate"><span class="pre">free_page()</span></code> 的实现方式</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">* Free a page of memory at physical address &#39;addr&#39;. Used by</span>
<span class="cm">* &#39;free_page_tables()&#39;</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">free_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">LOW_MEM</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">HIGH_MEMORY</span><span class="p">)</span>
        <span class="n">panic</span><span class="p">(</span><span class="s">&quot;trying to free nonexistent page&quot;</span><span class="p">);</span>
    <span class="n">addr</span> <span class="o">-=</span> <span class="n">LOW_MEM</span><span class="p">;</span>
    <span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem_map</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="o">--</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">mem_map</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">panic</span><span class="p">(</span><span class="s">&quot;trying to free free page&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>很容易发现 <code class="docutils literal notranslate"><span class="pre">panic</span></code> 的发生是由于 <code class="docutils literal notranslate"><span class="pre">mem_map[addr]=0</span></code> 时，<code class="docutils literal notranslate"><span class="pre">return</span></code> 不执行，继续往下执行到 <code class="docutils literal notranslate"><span class="pre">panic</span></code> 导致的；
也就是在 <code class="docutils literal notranslate"><span class="pre">mem_map[addr]</span></code> 为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 时尝试释放物理页导致的，即重复释放物理页。</p>
<p>我们考虑共享内存的实现方式，可以猜测，是共享一个物理页的多个进程中中的某一个将物理页释放了，
而这个变化没有反应到与它共享该段物理内存的进程中，致使后续其他进程再一次尝试释放它们共享的物理内存，导致了重复释放的错误。
在本次实验的 <code class="docutils literal notranslate"><span class="pre">produce.c</span></code> 和 <code class="docutils literal notranslate"><span class="pre">consum.c</span></code> 程序中，它们不会主动释放物理内存，那么必然是某个进程结束时资源的释放导致的。</p>
<p>这时问题的解决方案已经很明显了，既然 <code class="docutils literal notranslate"><span class="pre">panic</span></code> 是由进程错误地重复释放物理内存导致的，我们只要不让它重复释放即可。</p>
<p>思考一下，可以考虑修改这个 <code class="docutils literal notranslate"><span class="pre">bug</span></code> ，并记录修改过程。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab06.html" class="btn btn-neutral float-right" title="8. 打印进程地址转换过程" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab04.html" class="btn btn-neutral float-left" title="6. 信号量的实现和应用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2021, Dr. GuoJun LIU. All Rights Reserved.

    </p>
  </div>
 
	<script type="text/javascript">
		document.write(unescape("%3Cspan id='cnzz_stat_icon_1278706363'%3E%3C/span%3E%3Cscript src='https://s4.cnzz.com/z_stat.php%3Fid%3D1278706363%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));	
	</script>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>